<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProductosNaturales</title>
    <meta name="description" content="ProductosNaturales es una aplicaci&oacute;n que permite a los 
    usuarios buscar sucursales que vendan determinados productos naturales.">
    <meta name="author" content="Sofia Bruno y Federico Perez">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous">
        </script>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <script src="functions.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <ons-modal direction="up" id="cargando">
        <div style="text-align: center">
            <p>
                <ons-icon icon="md-spinner" size="28px" spin></ons-icon>
            </p>
        </div>
    </ons-modal>
    <!-- <ons-modal direction="up" id="loading"> 
        <div style="text-align: center">
            <p>
                <ons-icon icon="md-spinner" size="28px" spin></ons-icon>
            </p>
        </div>
    </ons-modal> -->

    <ons-navigator page="t_inicio" id="nav"></ons-navigator>

    <!-- Login -->
    <template id="t_inicio">
        <ons-page>
            <ons-card>
                <img src="img\inicio.png" alt="Logo de ProductosNaturales" style="width: 100%">

                <div class="content">
                    <h1>Iniciar Sesi&oacute;n</h1>
                    <!-- <label for="l_email">Email:</label> -->
                    <p><input class="text-input text-input--material" type="text" id="l_email" placeholder="Email"></p>
                    <!-- <label for="l_password">Contrase&ntilde;a:</label> -->
                    <p><input class="text-input text-input--material" type="password" id="l_password"
                            placeholder="Contrase&ntilde;a"></p>
                    <ons-button id="btn_iniciar" style="background-color: green;">Ingresar</ons-button>
                </div>
                <div class="content">
                    <button id="btn_registrar" class="button button--material--flat" style="color: green">Crear una
                        cuenta</button>
                </div>
            </ons-card>
        </ons-page>
    </template>


    <!-- Registro de usuarios -->
    <template id="t_registro">
        <ons-page id="p_registro">
            <script>
                ons.getScriptPage().onInit = function () {
                    $("#btn_registrarme").on("click", function () {
                        var ema = $("#email").val();
                        var pwd = $("#password").val();

                        try {
                            if (!ema) {
                                throw "Ingrese email para continuar";
                                //pregunta: de donde sale la validacion que obliga que sea formato de mail?
                                // Sofi! Es una muy buena pregunta, lo raro que lo valida, pregunta para hacer al profe!!
                            }
                            if (!pwd) {
                                throw "Ingrese contrase&ntilde;a para continuar";
                            }
                            // Elimine la validación de 8 caracteres, ahora la da mismo en "error", ya quedo funcionando

                            // Invocar API POST usuario
                            datos = { "email": ema, "password": pwd };

                            $.ajax({
                                url: "https://tiendanatural2020.herokuapp.com/api/user/register",
                                type: "POST",
                                dateType: "json",
                                data: datos,
                                success: function (respuesta) {
                                    ons.notification.toast("El usuario se registro correctamente", { "timeout": 3000 });

                                    var usuario = respuesta;
                                    sessionStorage.setItem("usr", usuario);
                                    var nav = document.getElementById("nav");
                                    nav.pushPage("t_productos");
                                },

                                error: function (xml, err, status) {
                                    if (xml.responseJSON.data) {
                                        ons.notification.toast(xml.responseJSON.data.error.errors.email.message, { "timeout": 3000 });
                                    } else {
                                        ons.notification.toast(xml.responseJSON.reason, { "timeout": 3000 });
                                    }
                                }
                            });

                        } catch (e) {
                            ons.notification.toast(e, { "timeout": 3000 });
                        }
                    });
                }

            </script>
            <ons-card>
                <div class="title">
                    <h1 style="color: green">Registro de nuevos usuarios</h1>
                </div>

                <label for="email">Email:</label>
                <p><input class="text-input text-input--material" type="text" id="email"></p>
                <label for="password">Contrase&ntilde;a:</label>
                <p><input class="text-input text-input--material" type="password" id="password"></p>
                <ons-button id="btn_registrarme" style="background-color: green;">Registrarse</ons-button>
            </ons-card>
        </ons-page>
    </template>


    <!-- Listado de Productos con Filtros -->
    <template id="t_productos">
        <ons-page id="p_productos">
            <script>
                ons.getScriptPage().onInit = function () {
                    // Acceder a un producto particular
                    $(document).on("click", ".listado_productos", function () {
                        var id_local = $(this).data("id");
                        var nav = document.getElementById("nav");
                        //  Redireccionar a informacion de un producto
                        nav.pushPage("t_infoproducto", { data: { id: id_local } });
                    });
                }
                ons.getScriptPage().onShow = function () {

                    var usuario = sessionStorage.getItem("usr");
                    usuario = JSON.parse(usuario);
                    $("#saludo").html("Hola <strong>" + usuario.email + "</strong>");

                    $.ajax({
                        url: "https://tiendanatural2020.herokuapp.com/api/product/all",
                        type: "GET",
                        dataType: "json",
                        success: function (respuesta) {
                            console.log(respuesta);
                            var item = "";
                            $.each(respuesta, function (k, producto) {
                                item = '<ons-list-item modifier="chevron longdivider" tappable tap-background-color="#3ED47A"\
                                 class="listado_productos" data-id="'+ producto._id + '"><div class="left"><img class="list-item__thumbnail"\
                                     src="'+ producto.photo + '"></div>\
                                <div class="center">\
                                <span class="list-item__title">'+ producto.name + '</span>\
                                <span class="list-item__subtitle">'+ producto.description + '</span>\
                                <span class="list-item__subtitle">$ '+ producto.price + '</span>\
                                <span class="list-item__subtitle">Stock en '+ producto.branches.length + ' sucursales</span>\
                                </div>\
                                </ons-list-item>';
                                $("#l_listado").append(item);
                            });
                        },
                        error: function (xml, err, status) {
                            ons.notification.toast(xml.responseJSON.data.error.errors.email.message, { "timeout": 3000 });
                        }
                    });
                }
            </script>
            <section>
                <h1>Listado de Productos</h1>
                <p id="saludo"></p>
                <input type="search" value="" placeholder="Search" class="search-input" style="width: 100%;">
                <ons-list id="l_listado"></ons-list>
            </section>
        </ons-page>
    </template>


    <!-- Mostrar detalle de la busqueda realizada -->
    <template id="t_infoproducto">
        <ons-page id="p_infoproducto">
            <script>
                ons.getScriptPage().onInit = function () {
                    $(document).on("click", "#btn_qr", function () {
                        ons.notification.alert("Click en QR", { title: "SCAN QR" });
                    });
                }
                ons.getScriptPage().onShow = function () {
                    var id_producto = this.data._id;

                    $.ajax({
                        url: "https://tiendanatural2020.herokuapp.com/api/product/all",
                        type: "GET",
                        dataType: "json",
                        success: function (respuesta) {
                            $.each(respuesta, function (k, producto) {
                                if (id_producto = producto._id) {
                                    $("#producto_imagen").attr("src", producto.photo);
                                    $("#producto_nombre").text(producto.name);
                                    $("#producto_descripcion").text(producto.description);
                                    $("#producto_precio").html('<ons-icon icon="fa-tags"></ons-icon> $ ' + producto.price);
                                }

                            });


                        },
                        error: function (xml, err, status) {
                            alert("Error");
                            //ons.notification.toast(xml.responseJSON.descripcion, { "timeout": 3000 });
                        }
                    });

                    // Pendiente, surge la duda ya que no tenemos url API de info por producto
                    // Supongo que se hara un each y mostraremos por el id que traemos y buscar el id
                    // en la API
                    // Aca vamos a mostrar un mapa donde muestre los locales donde se encuentra disponible
                    // el producto seleccionado



                }
            </script>
            <section>
                <ons-toolbar>
                    <div class="left">
                        <ons-toolbar-button>
                            <ons-back-button></ons-back-button>
                        </ons-toolbar-button>
                    </div>
                    <div class="center">
                        Info Producto
                    </div>
                </ons-toolbar>
                <ons-card>
                    <img id="producto_imagen" src="" style="width: 100%">
                    <div class="title">
                        <p id="producto_nombre"></p>
                    </div>
                    <div class="content">
                        <p id="producto_descripcion"></p>
                        <ons-list>
                            <ons-list-item>
                                <span id="producto_precio"></span>
                            </ons-list-item>
                        </ons-list>
                    </div>
                </ons-card>
                <p>
                    <ons-button id="btn_qr" modifier="large--cta">SCAN QR</ons-button>
                </p>
            </section>
        </ons-page>
    </template>

    <!-- Listado de busquedas realizadas por el usuario -->




    <!-- Ver información de producto en sucursal -->



</body>

</html>