<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NombreTiendaOnline</title>
    <meta name="description" content="NombreTiendaOnline es una aplicaci&oacute;n que permite a los 
    usuarios buscar sucursales que vendan determinados productos naturales.">
    <meta name="author" content="Sofia Bruno y Federico Perez">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous">
        </script>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <script src="functions.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <ons-navigator page="t_inicio" id="nav"></ons-navigator>

    <template id="t_inicio">
        <ons-page>
            <ons-card>
                <img src="img\inicio.png" alt="Onsen UI" style="width: 100%">

                <div class="content">
                    <h1>Iniciar Sesi&oacute;n</h1>
                    <label for="l_email">Email:</label>
                    <p><input class="text-input text-input--material" type="text" id="l_email"></p>
                    <label for="l_password">Contrase&ntilde;a:</label>
                    <p><input class="text-input text-input--material" type="password" id="l_password"></p>
                    <ons-button id="btn_iniciar" style="background-color: green;">Ingresar</ons-button>
                </div>
                <div>
                    <button id="btn_registrar" class="button button--material--flat" style="color: green">Crear una
                        cuenta</button>
                </div>
            </ons-card>
        </ons-page>
    </template>


    <!-- Registro de usuarios -->
    <template id="t_registro">
        <ons-page id="p_registro">
            <script>
                ons.getScriptPage().onInit = function () {
                    $("#btn_registrar").on("click", function () {
                        var ema = $("#email").val();
                        var pwd = $("#password").val();

                        try {
                            if (!ema) {
                                throw "Ingrese email para continuar";
                                //pregunta: de donde sale la validacion que obliga que sea formato de mail?
                            }
                            if (!pwd) {
                                throw "Ingrese contrase&ntilde;a para continuar";
                            }
                            if (pwd.length < 8) {
                                throw "La contrase&ntilde;a debe contener 8 caracteres como m&iacute;nimo";
                            }

                            // Invocar API POST usuario
                            datos = { "email": ema, "password": pwd };

                            $.ajax({
                                url: "https://tiendanatural2020.herokuapp.com/api/user/register",
                                type: "POST",
                                dateType: "json",
                                data: datos,
                                success: function (respuesta) {
                                    ons.notification.toast("El usuario se registro correctamente", { "timeout": 3000 });

                                    var usuario = respuesta;
                                    sessionStorage.setItem("usr", usuario);
                                    var nav = document.getElementById("nav");
                                    nav.pushPage("t_productos");
                                },

                                error: function (xml, err, status) {
                                    ons.notification.toast(xml.responseJSON.data.error.errors.email.message, { "timeout": 3000 });
                                    // Este msj nos comunica si se repite el mail, o si el formato no es el correcto
                                    // ons.notification.toast(xml.responseJSON.reason, { "timeout": 3000 });  
                                    // Este error segun la API nos avisa que la contraseña deberia tener 8 caracteres como minimo
                                    // genere una validacion al principio del try, ver si se puede usar el mensaje mismo de la API
                                }
                            });

                        } catch (e) {
                            ons.notification.toast(e, { "timeout": 3000 });
                        }

                    });
                }

            </script>

            <ons-card>
                <div class="title">
                    <h1 style="color: green">Registro de nuevos usuarios</h1>
                </div>

                <label for="email">Email:</label>
                <p><input class="text-input text-input--material" type="text" id="email"></p>
                <label for="password">Contrase&ntilde;a:</label>
                <p><input class="text-input text-input--material" type="password" id="password"></p>
                <ons-button id="btn_registrar" style="background-color: green;">Registrarse</ons-button>
            </ons-card>
        </ons-page>
    </template>

    


    <!-- Listado de Productos con Filtros -->
    <template id="t_productos">
        <ons-page id="p_productos">
            <script>
                /*ons.getScriptPage().onInit = function () {
                    // Acceder a un producto particular
                    $(document).on("Click", ".listado_productos"), function(){
                        var id_local = $(this).data("id");
                        var nav = document.getElementById("nav");
                        //  Redireccionar a informacion de un producto
                        nav.pushPage("t_infoproducto", {data:{id:id_local}});
                    }
                }*/
                ons.getScriptPage().onShow = function () {

                    var usuario = sessionStorage.getItem("usr");
                    usuario = JSON.parse(usuario);
                    $("#saludo").html("Hola <strong>" + usuario.email + "</strong>");

                    $.ajax({
                        url: "https://tiendanatural2020.herokuapp.com/api/product/all",
                        type: "GET",
                        dataType: "json",
                        success: function (respuesta) {
                            console.log(respuesta);
                            var item = "";
                            $.each(respuesta, function (k, producto) {
                                item = '<ons-list-item modifier="chevron longdivider" tappable tap-background-color="#3ED47A"\
                                 class="listado_locales" data-id="'+ producto._id + '"><div class="left"><img class="list-item__thumbnail"\
                                     src="'+ producto.photo + '"></div>\
                                <div class="center">\
                                <span class="list-item__title">'+ producto.name + '</span>\
                                <span class="list-item__subtitle">'+ producto.description + '</span>\
                                <span class="list-item__subtitle">$ '+ producto.price + '</span>\
                                </div>\
                                </ons-list-item>';
                                $("#l_listado").append(item);
                            });
                        },
                        error: function (xml, err, status) {
                            ons.notification.toast(xml.responseJSON.data.error.errors.email.message, { "timeout": 3000 });
                        }

                    });
                }
            </script>
            <section>
                <h1>Listado de Productos</h1>
                <p id="saludo"></p>
                <input type="search" value="" placeholder="Search" class="search-input" style="width: 100%;">
                <ons-list id="l_listado"></ons-list>
            </section>
        </ons-page>
    </template>

    <!-- Mostrar detalle de la busqueda realizada -->
    <template id="t_infoproducto">
        <ons-page id="p_infoproducto">
            <script>
                ons.getScriptPage().onInit = function () {
                    $(document).on("click", "#btn_qr", function () {
                        ons.notification.alert("Click en QR", { title: "SCAN QR" });
                    });
                }
                ons.getScriptPage().onShow = function () {
                    var id_producto = this.data._id;

                    // Pendiente, surge la duda ya que no tenemos url API de info por producto



                }
            </script>
            <section>
                <ons-card>
                    <img id="producto_imagen" src="" style="width: 100%">
                    <div class="title">
                        <p id="producto_nombre"></p>
                    </div>
                    <div class="content">
                        <p id="producto_descripcion"></p>
                        <ons-list>
                            <ons-list-item>
                                <span id="producto_precio"></span>
                            </ons-list-item>
                        </ons-list>
                    </div>
                </ons-card>
                <p>
                    <ons-button id="btn_qr" modifier="large--cta">SCAN QR</ons-button>
                </p>
            </section>
        </ons-page>
    </template>

    <!-- Listado de busquedas realizadas por el usuario -->




    <!-- Ver información de producto en sucursal -->



</body>

</html>